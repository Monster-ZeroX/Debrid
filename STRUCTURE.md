# Project Structure

This document explains the complete file structure of the self-hosted debrid service.

```
self-hosted-debrid/
├── src/                           # TypeScript source code
│   ├── index.ts                  # Application entry point
│   ├── app.ts                    # Express server setup and configuration
│   ├── config/
│   │   └── index.ts             # Environment variable configuration
│   ├── types/
│   │   └── index.ts             # TypeScript type definitions and interfaces
│   ├── services/
│   │   └── debridProvider.ts   # Core torrent engine (WebTorrent wrapper)
│   ├── routes/
│   │   ├── stremio.ts          # Stremio addon endpoints
│   │   ├── mediafusion.ts      # MediaFusion provider endpoints
│   │   └── stream.ts           # HTTP streaming endpoints
│   ├── middleware/
│   │   └── index.ts            # Authentication and error handling
│   └── utils/
│       └── index.ts            # Utility functions
│
├── dist/                         # Compiled JavaScript (generated by build)
│   └── [build output]           # Git-ignored, created by `npm run build`
│
├── package.json                  # Node.js dependencies and scripts
├── tsconfig.json                 # TypeScript compiler configuration
├── Procfile                      # Heroku process definition
├── app.json                      # Heroku app manifest (for Deploy button)
├── .env.example                  # Environment variables template
├── .gitignore                    # Git ignore rules
├── LICENSE                       # MIT License
├── README.md                     # Main documentation
└── QUICKSTART.md                 # Beginner-friendly setup guide
```

## File Descriptions

### Root Configuration Files

- **package.json**: Defines Node.js dependencies, scripts, and project metadata
- **tsconfig.json**: TypeScript compiler options and settings
- **Procfile**: Tells Heroku how to start the app (`web: node dist/index.js`)
- **app.json**: Heroku app metadata, buildpacks, and env var definitions
- **.env.example**: Template for local environment variables
- **.gitignore**: Files and folders to exclude from git
- **LICENSE**: MIT License text

### Documentation

- **README.md**: Complete documentation with setup, deployment, and usage
- **QUICKSTART.md**: Step-by-step guide for beginners

### Source Code (`src/`)

#### Entry Points

- **src/index.ts**
  - Application entry point
  - Starts the Express server
  - Handles graceful shutdown signals

- **src/app.ts**
  - Creates and configures Express application
  - Sets up middleware (CORS, helmet, compression)
  - Defines routes
  - Error handling

#### Configuration

- **src/config/index.ts**
  - Loads environment variables
  - Validates configuration
  - Exports typed config object

#### Type Definitions

- **src/types/index.ts**
  - TypeScript interfaces for:
    - Torrent metadata
    - Stream sources
    - Stremio API requests/responses
    - MediaFusion API requests/responses
    - Configuration

#### Services

- **src/services/debridProvider.ts**
  - Core torrent engine abstraction
  - WebTorrent wrapper with cleanup logic
  - Torrent management (add, remove, status)
  - File selection (best video file)
  - Stream URL generation
  - Singleton pattern for global access

#### Routes

- **src/routes/stremio.ts**
  - `GET /stremio/manifest.json` - Stremio addon manifest
  - `GET /stremio/stream/:type/:id.json` - Stream endpoint
  - `GET /stremio/health` - Health check

- **src/routes/mediafusion.ts**
  - `POST /mediafusion/resolve` - Resolve torrent to stream URL
  - `GET /mediafusion/status/:infoHash` - Torrent status
  - `GET /mediafusion/info` - Provider information
  - `GET /mediafusion/health` - Health check

- **src/routes/stream.ts**
  - `GET /stream/:infoHash/:fileIndex` - HTTP streaming endpoint
  - Supports HTTP range requests for seeking
  - Content-Type detection
  - Direct WebTorrent file streaming

#### Middleware

- **src/middleware/index.ts**
  - `authMiddleware` - Optional token authentication
  - `errorHandler` - Global error handling
  - `notFoundHandler` - 404 handler

#### Utilities

- **src/utils/index.ts**
  - Magnet URI parsing
  - Info hash validation
  - File size formatting
  - Duration formatting
  - Video file detection
  - Filename sanitization
  - HTTP range parsing
  - Retry logic

## Data Flow

### Stremio Integration

```
Stremio App
    ↓
GET /stremio/manifest.json
    ↓
User selects content
    ↓
GET /stremio/stream/:type/:id.json
    ↓
DebridProvider.addTorrent(infoHash)
    ↓
WebTorrent fetches metadata
    ↓
Select best video file
    ↓
Return stream URL
    ↓
Stremio plays: GET /stream/:infoHash/:fileIndex
    ↓
WebTorrent streams file chunks
```

### MediaFusion Integration

```
MediaFusion
    ↓
POST /mediafusion/resolve
    { infoHash, fileIndex }
    ↓
DebridProvider.addTorrent(infoHash)
    ↓
WebTorrent fetches metadata
    ↓
Return { url, name, size, ready }
    ↓
MediaFusion provides to Stremio
    ↓
Stremio plays: GET /stream/:infoHash/:fileIndex
```

## Key Design Decisions

### 1. WebTorrent Engine

- **Why**: Pure JavaScript, works in Node.js, no native dependencies
- **How**: `DebridProvider` wraps WebTorrent client
- **Tradeoff**: Slightly slower than native clients, but easier deployment

### 2. In-Memory Torrents

- **Why**: Heroku has ephemeral filesystem
- **How**: WebTorrent keeps data in memory/tmp
- **Tradeoff**: Limited by dyno RAM, but works with Heroku constraints

### 3. Singleton Pattern

- **Why**: Single torrent client across all requests
- **How**: `getDebridProvider()` returns global instance
- **Benefit**: Efficient resource usage, shared torrent connections

### 4. Auto-Cleanup

- **Why**: Prevent memory leaks on long-running service
- **How**: Periodic check removes inactive torrents
- **Limit**: `MAX_TORRENTS` config (default: 10)

### 5. Optional Authentication

- **Why**: Flexible security based on use case
- **How**: Middleware checks `AUTH_TOKEN` if set
- **Methods**: Bearer token header or query parameter

### 6. Separate Route Handlers

- **Why**: Modular, maintainable code
- **How**: Each integration (Stremio, MediaFusion) has own router
- **Benefit**: Easy to add more integrations later

## Environment Variables

See `.env.example` for all available variables:

| Variable | Purpose | Required |
|----------|---------|----------|
| PORT | Server port | No (Heroku sets) |
| NODE_ENV | Environment mode | No |
| BASE_URL | Public URL | Yes |
| AUTH_TOKEN | API authentication | No |
| TORRENT_TIMEOUT | Metadata timeout | No |
| MAX_TORRENTS | Concurrent limit | No |
| DOWNLOAD_PATH | Temp file path | No |

## NPM Scripts

```json
{
  "dev": "ts-node-dev --respawn --transpile-only src/index.ts",
  "build": "tsc",
  "start": "node dist/index.js",
  "lint": "eslint src --ext .ts",
  "type-check": "tsc --noEmit"
}
```

- **dev**: Development mode with hot reload
- **build**: Compile TypeScript to JavaScript
- **start**: Run production build
- **lint**: Check code quality (requires ESLint setup)
- **type-check**: Validate types without building

## Dependencies

### Production

- **express**: HTTP server framework
- **cors**: Cross-origin resource sharing
- **dotenv**: Environment variable loader
- **webtorrent**: P2P torrent engine
- **parse-torrent**: Torrent metadata parser
- **morgan**: HTTP request logger
- **helmet**: Security headers
- **compression**: Response compression

### Development

- **typescript**: TypeScript compiler
- **@types/\***: Type definitions
- **ts-node-dev**: Development server with hot reload
- **eslint**: Code linting (optional)

## Build Process

1. **Development**: `npm run dev`
   - Runs TypeScript directly with hot reload
   - No build step required

2. **Production Build**: `npm run build`
   - Compiles `src/` to `dist/`
   - Generates `.js`, `.js.map`, `.d.ts` files
   - Validates types

3. **Production Run**: `npm start`
   - Runs compiled `dist/index.js`
   - Node.js executes pure JavaScript

4. **Heroku Deploy**:
   - Heroku runs `npm install`
   - Heroku runs `npm run build` (if defined)
   - Heroku runs command from `Procfile`

## Adding New Features

### Adding a new endpoint

1. Create handler in appropriate route file (`src/routes/`)
2. Add to router: `router.get('/new-endpoint', handler)`
3. Update README with endpoint documentation

### Adding a new integration

1. Create new route file: `src/routes/newservice.ts`
2. Define API endpoints
3. Register router in `src/app.ts`
4. Update README and QUICKSTART

### Modifying torrent behavior

1. Edit `src/services/debridProvider.ts`
2. WebTorrent API: https://webtorrent.io/docs
3. Test thoroughly (torrents are stateful)

## Testing Locally

```bash
# Install dependencies
npm install

# Create .env
cp .env.example .env
# Edit .env: set BASE_URL=http://localhost:3000

# Build
npm run build

# Run
npm start

# Or use dev mode
npm run dev
```

Then test with curl or browser:
```bash
curl http://localhost:3000/health
curl http://localhost:3000/stremio/manifest.json
```

## Deployment to Heroku

See README.md and QUICKSTART.md for detailed deployment instructions.

**Key files for Heroku**:
- `Procfile` - Defines web process
- `app.json` - Deploy button configuration
- `package.json` - Specifies Node.js version and build script

---

**This structure follows Node.js/Express best practices with clean separation of concerns.**
